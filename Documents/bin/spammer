#!/bin/sh
set -eu

# In case of an error, backof and reexec.
trap 'echo "Caught error, restarting..." >&2; sleep 1; exec $HOME/Documents/bin/spammer' EXIT

export PATH="$HOME/Documents/bin:$PATH"
URL='https://patchbay.pub/pubsub/1446c969-9a54-4b5b-83e0-bf88f22f289d'

while true
do
    message="$(curl --silent "$URL")"
    logger --tag "spammer" "$message"
    if echo "$message" | grep --silent '^message='
    then
        message="$(echo "$message" | urldecode | sed 's/message=//')"
    fi
    echo "$message" | notify \
        --urgency low \
        --hint "string:desktop-entry:spammer"
done
