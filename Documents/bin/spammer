#!/bin/sh
set -eu

export PATH="$HOME/Documents/bin:$PATH"
URL='https://patchbay.pub/pubsub/1446c969-9a54-4b5b-83e0-bf88f22f289d'

while true
do
    message="$(curl --silent "$URL" || true)"
    exitstatus="$?"
    # Backoff in case of an error.
    if [ -z "${message:-}" ] || [ "$exitstatus" -gt '0' ]
    then
        sleep 1
        break
    fi
    logger --tag "spammer" "$message"
    if echo "$message" | grep --silent '^message='
    then
        message="$(echo "$message" | sed 's/message=//; s/+/ /g')"
    fi
    echo "$message" | notify \
        --urgency low \
        --hint "string:desktop-entry:spammer"
done
