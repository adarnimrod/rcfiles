#!/bin/sh
set -eu

notify () { printf '\n\e[1;94m=== %s ====\e[0m\n\n' "$1" >&2; }

cd "$(git rev-parse --show-toplevel)"
notify 'Generating some configuration and private files.'
make --directory "$HOME" --always-make --keep-going || true
notify 'Installing Git hooks'
Documents/bin/install-git-hooks
notify 'Loading dconf config'
Documents/bin/dconf-load
notify 'Configuring Git repo'
git config --local status.showUntrackedFiles no
notify 'Setting up Git submodules'
git bull
if command -pv vagrant > /dev/null
then
	notify 'Installing Vagrant plugins'
    for plugin in landrush vagrant-gatling-rsync vagrant-disksize
    do
        vagrant plugin list | grep -qw "$plugin" || vagrant plugin install "$plugin" || true
    done
fi
if command -v helm > /dev/null
then
    notify 'Installing Helm plugins'
    eval "$(grep 'export HELM_HOME' .bashrc)"
    helm plugin list | { ! grep --silent '^diff'; } || helm plugin remove diff
    helm plugin install https://github.com/databus23/helm-diff --version master
fi
